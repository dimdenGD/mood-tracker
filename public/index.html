<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=600">
        <title>Mood Tracker</title>
        <style>
            body {
                background-color: #42619d;
                font-family: "MS UI Gothic", sans-serif;
                margin: 0;
            }
            .center {
                text-align: center;
            }
            #dot {
                position: absolute;
                opacity: 0.7;
            }
            #moods, #dot {
                user-select: none;
                -moz-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                -webkit-user-drag: none;
            }
            #mood {
                padding: 3px 6px;
                margin: 0 auto;
                margin-bottom: 5px;
                display: block;
                width: fit-content;
            }
            #bg {
                position: fixed;
                bottom: 0;
                width: 100%;
                z-index: -1;
            }
            h1 {
                margin: 0;
                margin-top: 34px;
                padding: 0;
                font-size: 48px;
                color: #fff;
                text-shadow: 0 0 10px #000;
            }
            rect {
                opacity: 0.6;
            }
            .selected {
                opacity: 0.9;
            }
            .chart {
                width: 90%;
                height: 400px;
                margin: 0 auto;
                user-select: none;
                background-color: white;
                border-radius: 3px;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            }
            text, #mood {
                display: none;
            }
            #offline {
                position: fixed;
                top: 5px;
                left: 5px;
            }
            .square-chart {
                max-width: 700px;
                height: 600px;
            }
            #hourlies {
                display: flex;
                place-content: center;
            }
            @media screen and (max-width: 1450px) {
                #hourlies {
                    display: block;
                }
            }
            @media screen and (max-width: 600px) {
                .center {
                    margin-top: 120px;
                }
            }
        </style>
    </head>
    <body>
        <span id="offline" hidden>Offline mode</span>
        <img src="./moonclouds.webp" id="bg">
        <div class="center">
            <h1>Mood Tracker</h1>
            <div id="stuff">
                <span style="transform: rotate(-90deg);display: block;position: relative;right: 270px;top: 266px;">Low Energy <----------------------> High Energy</span>
                <img src="./reddot.png" alt="reddot" id="dot" width="24" height="24" draggable="false">
                <svg version="1.1" width="518" height="518" xmlns="http://www.w3.org/2000/svg" alt="moods" id="moods" draggable="false">
                    <rect x="2" y="2" width="84" height="84" fill="#9b0b00"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="44" y="44" data-name="Enraged">Enraged</text>
                    <rect x="88" y="2" width="84" height="84" fill="#d72121"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="130" y="44" data-name="Angry">Angry</text>
                    <rect x="174" y="2" width="84" height="84" fill="#e64f22"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="216" y="44" data-name="Shocked">Shocked</text>
                    <rect x="260" y="2" width="84" height="84" fill="#ff914c"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="302" y="44" data-name="Manic">Manic</text>
                    <rect x="346" y="2" width="84" height="84" fill="#febd59"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="388" y="44" data-name="Festive">Festive</text>
                    <rect x="432" y="2" width="84" height="84" fill="#ffde59"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="474" y="44" data-name="Ecstatic">Ecstatic</text>
                
                    <rect x="2" y="88" width="84" height="84" fill="#9b0b00"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="42" y="130" data-name="Fuming">Fuming</text>
                    <rect x="88" y="88" width="84" height="84" fill="#d72121"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="130" y="130" data-name="Stressed">Stressed</text>
                    <rect x="174" y="88" width="84" height="84" fill="#e64f22"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="216" y="130" data-name="Restless">Restless</text>
                    <rect x="260" y="88" width="84" height="84" fill="#ff914c"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="302" y="130" data-name="Energized">Energized</text>
                    <rect x="346" y="88" width="84" height="84" fill="#febd59"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="389" y="130" data-name="Motivated">Motivated</text>
                    <rect x="432" y="88" width="84" height="84" fill="#ffde59"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="474" y="130" data-name="Excited">Excited</text>
                    
                    <rect x="2" y="174" width="84" height="84" fill="#9b0b00"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="43" y="216" data-name="Anxious,">Anxious</text>
                    <rect x="88" y="174" width="84" height="84" fill="#d72121"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="131" y="216" data-name="Worried">Worried</text>
                    <rect x="174" y="174" width="84" height="84" fill="#e64f22"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="216" y="216" data-name="Uneasy">Uneasy</text>
                    <rect x="260" y="174" width="84" height="84" fill="#ff914c"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="302" y="216" data-name="Pleasant">Pleasant</text>
                    <rect x="346" y="174" width="84" height="84" fill="#febd59"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="388" y="216" data-name="Cheerful">Cheerful</text>
                    <rect x="432" y="174" width="84" height="84" fill="#ffde59"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="474" y="216" data-name="Blissful">Blissful</text>
                
                    <rect x="2" y="260" width="84" height="84" fill="#668ea8"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="43" y="302" data-name="Anxious">Anxious</text>
                    <rect x="88" y="260" width="84" height="84" fill="#85b3c8"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="130" y="302" data-name="Down">Down</text>
                    <rect x="174" y="260" width="84" height="84" fill="#ccdde5"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="216" y="302" data-name="Apathetic">Apathetic</text>
                    <rect x="260" y="260" width="84" height="84" fill="#c3d194"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="302" y="302" data-name="At ease">At ease</text>
                    <rect x="346" y="260" width="84" height="84" fill="#a1ad7d"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="388" y="302" data-name="Content">Content</text>
                    <rect x="432" y="260" width="84" height="84" fill="#6b7a41"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="474" y="302" data-name="Fulfilled">Fulfilled</text>
                
                    <rect x="2" y="346" width="84" height="84" fill="#668ea8"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="44" y="388" data-name="Miserable">Miserable</text>
                    <rect x="88" y="346" width="84" height="84" fill="#85b3c8"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="130" y="388" data-name="Sad">Sad</text>
                    <rect x="174" y="346" width="84" height="84" fill="#ccdde5"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="216" y="388" data-name="Tired">Tired</text>
                    <rect x="260" y="346" width="84" height="84" fill="#c3d194"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="302" y="388" data-name="Relaxed">Relaxed</text>
                    <rect x="346" y="346" width="84" height="84" fill="#a1ad7d"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="388" y="388" data-name="Restful">Restful</text>
                    <rect x="432" y="346" width="84" height="84" fill="#6b7a41"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="474" y="388" data-name="Satisfied">Satisfied</text>
                
                    <rect x="2" y="432" width="84" height="84" fill="#668ea8"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="42" y="474" data-name="Despair">Despair</text>
                    <rect x="88" y="432" width="84" height="84" fill="#85b3c8"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="130" y="474" data-name="Desolate">Desolate</text>
                    <rect x="174" y="432" width="84" height="84" fill="#ccdde5"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="216" y="474" data-name="Drained">Drained</text>
                    <rect x="260" y="432" width="84" height="84" fill="#c3d194"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="302" y="474" data-name="Sleepy">Sleepy</text>
                    <rect x="346" y="432" width="84" height="84" fill="#a1ad7d"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="388" y="474" data-name="Tranquil">Tranquil</text>
                    <rect x="432" y="432" width="84" height="84" fill="#6b7a41"/>
                    <text font-family="MS UI Gothic" font-weight="bold" text-anchor="middle" dominant-baseline="middle" x="474" y="474" data-name="Serene">Serene</text>
                </svg>
                <br>
                <span>Unpleasant <----------------------> Pleasant</span>
                <br>
                <br>
                <span id="mood">Unknown</span>
                <span>Pleasantness: <span id="pleasantness">0.00</span></span>
                <br>
                <span>Energy: <span id="energy">0.00</span></span>
                <br>
                <span>Updated: <span id="date">2023-05-01 12:00:00</span></span>
                <br>
                <span style="font-size:12px">by <a href="https://dimden.dev/">dimden</a> â€¢ <a href="https://github.com/dimdenGD/mood-tracker" target="_blank">github</a></span>
            </div>
            <br>
            <details>
                <summary>Analytics</summary>
                <br>
                Since: <input type="date" id="after" value="2023-05-04"> <button id="all">All</button>
                <br><br>
                <div>
                    <div id="mainchart-div">
                        <h2>Main chart</h2>
                        Average: <input id="sma" type="number" value="1" min="1" style="width:30px"> Use WMA: <input id="wma" type="checkbox" checked>
                        <br><br>
                        <div id="mainchart" class="chart"></div>
                    </div>
                    <div id="add-mood" hidden>
                        <br>
                        <input type="datetime-local" id="add-mood-date">
                        <input type="number" id="add-mood-pleasantness" placeholder="Pleasantness" min="-1" max="1" value="0" step="0.01">
                        <input type="number" id="add-mood-energy" placeholder="Energy" min="-1" max="1" value="0" step="0.01">
                        <button id="add-mood-button">Add</button>
                    </div>
                    <br>
                    <br>
                    <div id="heatmap">
                        <h2>Heatmap</h2>
                        <!-- <div id="heatmap-dots" style="margin-left:-512px"></div> -->
                        <canvas id="heatmap-canvas" width="518" height="518" style="position:absolute"></canvas>
                        <img src="./moods.svg" width="518" height="518">
                    </div>
                    <br>
                    <br>
                    <div id="hourlies">
                        <div id="hourly-average-energy-div">
                            <h2>Hourly average energy</h2>
                            <div id="hourly-average-energy" class="chart square-chart"></div>
                        </div>
                        <div id="hourly-average-pleasantness-div">
                            <h2>Hourly average pleasantness</h2>
                            <div id="hourly-average-pleasantness" class="chart square-chart"></div>
                        </div>
                    </div>
                    <br>
                    <br>
                    <div id="dailies">
                        <div id="daily-average-pleasantness-div">
                            <h2>Daily average pleasantness</h2>
                            <div id="daily-average-pleasantness" class="chart" style="width:700px;height:175px"></div>
                        </div>
                        <div id="daily-average-energy-div">
                            <h2>Daily average energy</h2>
                            <div id="daily-average-energy" class="chart" style="width:700px;height:175px"></div>
                        </div>
                    </div>
                    <br><br><br><br><br><br>
                </div>
            </details>
        </div>
        <script>
            if('serviceWorker' in navigator) {
                let registration;

                const registerServiceWorker = async () => {
                    registration = await navigator.serviceWorker.register('./sw.js');
                };

                registerServiceWorker();
            }
            let moods = document.getElementById("moods");
            let dot = document.getElementById("dot");
            let rects = moods.getElementsByTagName("rect");

            function setCoords(pleasantness, energy, gray) {
                let x = (pleasantness + 1) * 262;
                let y = (energy + 1) * 262;
                y = 518 - y;

                dot.style.marginLeft = x-15 + "px";
                dot.style.marginTop = y-10 + "px";

                document.getElementById("pleasantness").innerText = pleasantness.toFixed(2);
                document.getElementById("energy").innerText = energy.toFixed(2);
                let [text, color, emoji] = getMoodInfo(pleasantness, energy);
                document.getElementById("mood").innerText = text;
                let icon = document.getElementById("icon");
                if(!icon) {
                    icon = document.createElement("link");
                    icon.rel = "icon";
                    icon.id = "icon";
                    icon.href = `./fbemoji/${emoji}.png`;
                    document.head.appendChild(icon);
                } else {
                    icon.href = `./fbemoji/${emoji}.png`;
                }
                document.getElementById("mood").style.backgroundColor = "#" + color;
                if(gray) dot.style.filter = "grayscale(0.4)";
                else dot.style.filter = "";

                for(let rect of rects) {
                    rect.className.baseVal = "";
                }
                let rect = document.querySelector(`text[data-name="${text}"]`);
                if(rect) rect.previousElementSibling.className.baseVal = "selected";
            }
            let lastPleasantness = 0;
            let lastEnergy = 0;
            setCoords(lastPleasantness, lastEnergy, true);

            function update(e) {
                if(!localStorage.admin) return;
                let rect = moods.getBoundingClientRect();
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;
                y = 518 - y;
                lastPleasantness = +((x / 518) * 2 - 1).toFixed(2);
                lastEnergy = (+((y / 518) * 2 - 1).toFixed(2));
                setCoords(lastPleasantness, lastEnergy, true);
            }
            let offline = false;
            function sync(doGet = true) {
                offline = false;
                if(localStorage.toSend && localStorage.admin) {
                    let toSend = [];
                    try {
                        toSend = JSON.parse(localStorage.toSend);
                    } catch(e) {
                        return alert("Error parsing data: " + e);
                    }
                    fetch("/services/mood/setmultiple", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            moods: toSend,
                            pass: localStorage.admin
                        })
                    }).then(res => res.text()).then(res => {
                        if(res === 'added') {
                            document.getElementById('offline').hidden = false;
                            document.getElementById('offline').innerText = `Sent ${toSend.length} moods`;
                            setTimeout(() => {
                                document.getElementById('offline').hidden = true;
                                document.getElementById('offline').innerText = `Offline`;
                            }, 3000);
                            delete localStorage.toSend;
                            if(doGet) {
                                get();
                                if(window.updateData) updateData(new Date(document.getElementById('after').value).getTime());
                            }
                        }
                    })
                } else {
                    document.getElementById('offline').hidden = true;
                }
            }
            function get() {
                fetch("/services/mood/get").then(res => res.json()).then(res => {
                    if(offline || localStorage.toSend) {
                        return sync();
                    }
                    if(res.error) {
                        return alert("Error getting data: " + res.error);
                    }
                    lastPleasantness = res.pleasantness;
                    lastEnergy = res.energy;
                    setCoords(lastPleasantness, lastEnergy, false);
                    localStorage.lastCachedMood = JSON.stringify(res);
                    document.getElementById('date').innerText = new Date(res.timestamp).toLocaleString();
                }).catch(e => {
                    offline = true;
                    document.getElementById('offline').hidden = false;
                    if(localStorage.toSend) {
                        let toSend = [];
                        try {
                            toSend = JSON.parse(localStorage.toSend);
                        } catch(e) {
                            toSend = [];
                        }

                        let lastMood = toSend[toSend.length - 1];
                        if(lastMood) {
                            lastPleasantness = lastMood.pleasantness;
                            lastEnergy = lastMood.energy;
                            setCoords(lastPleasantness, lastEnergy, false);
                            document.getElementById('date').innerText = new Date(lastMood.timestamp).toLocaleString();
                        }
                    } else if(localStorage.lastCachedMood) {
                        let lastMood = JSON.parse(localStorage.lastCachedMood);
                        lastPleasantness = lastMood.pleasantness;
                        lastEnergy = lastMood.energy;
                        setCoords(lastPleasantness, lastEnergy, false);
                        document.getElementById('date').innerText = new Date(lastMood.timestamp).toLocaleString();
                    }
                });
            }
            if(localStorage.lastCachedMood) {
                let lastMood = JSON.parse(localStorage.lastCachedMood);
                lastPleasantness = lastMood.pleasantness;
                lastEnergy = lastMood.energy;
                setCoords(lastPleasantness, lastEnergy, false);
                document.getElementById('date').innerText = new Date(lastMood.timestamp).toLocaleString();
            }
            get();
            setInterval(get, 1000 * 60);
            function send() {
                if(!localStorage.admin) return;
                function err(e) {
                    let toSend = [];
                    try {
                        toSend = JSON.parse(localStorage.toSend);
                    } catch(e) {
                        toSend = [];
                    }

                    let lastMood = toSend[toSend.length - 1];
                    if(lastMood && Date.now() - lastMood.timestamp < 60000) {
                        lastMood.pleasantness = lastPleasantness;
                        lastMood.energy = lastEnergy;
                        dot.style.filter = `hue-rotate(209deg)`;
                    } else {
                        toSend.push({
                            pleasantness: lastPleasantness,
                            energy: lastEnergy,
                            timestamp: Date.now()
                        });
                        dot.style.filter = `hue-rotate(132deg)`;
                        document.getElementById('date').innerText = new Date().toLocaleString();
                    }
                    setTimeout(() => {
                        dot.style.filter = "";
                    }, 1000);
                    localStorage.toSend = JSON.stringify(toSend);
                }
                const controller = new AbortController();
                controller.signal.addEventListener("abort", () => {
                    console.log("Aborted");
                    err();
                });
                const timeoutId = setTimeout(() => controller.abort(), 1500);
                fetch("/services/mood/set", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        pleasantness: lastPleasantness,
                        energy: lastEnergy,
                        pass: localStorage.admin
                    }),
                    signal: controller.signal
                }).then(res => res.text()).then(res => {
                    clearInterval(timeoutId);
                    if(res !== 'added' && res !== 'edited') {
                        return alert("Error: " + res);
                    }
                    if(offline || localStorage.toSend) {
                        sync(false);
                    }
                    dot.style.filter = `hue-rotate(${res === 'added' ? '132' : '209'}deg)`;
                    if(res === 'added') document.getElementById('date').innerText = new Date().toLocaleString();

                    localStorage.lastCachedMood = JSON.stringify({
                        pleasantness: lastPleasantness,
                        energy: lastEnergy,
                        timestamp: Date.now()
                    });

                    if(window.updateData) updateData(new Date(document.getElementById('after').value).getTime());
                    setTimeout(() => {
                        dot.style.filter = "";
                    }, 1000);
                }).catch(e => {
                    clearInterval(timeoutId);
                    err();
                });
            }
            function getMoodInfo(pleasantness, energy) {
                if(energy >= 0.67) {
                    if(pleasantness >= 0.67) {
                        return ["Ecstatic", "ffde59", "bigsmile"];
                    } else if(pleasantness >= 0.33) {
                        return ["Festive", "febd59", "bigsmile"];
                    } else if(pleasantness >= 0) {
                        return ["Manic", "ff914c", "pacman"];
                    } else if(pleasantness >= -0.33) {
                        return ["Shocked", "e64f22", "scared"];
                    } else if(pleasantness >= -0.67) {
                        return ["Angry", "d72121", "anger"];
                    } else {
                        return ["Enraged", "9b0b00", "anger"];
                    }
                } else if(energy >= 0.33) {
                    if(pleasantness >= 0.67) {
                        return ["Excited", "ffde59", "o"];
                    } else if(pleasantness >= 0.33) {
                        return ["Motivated", "febd59", "fine"];
                    } else if(pleasantness >= 0) {
                        return ["Energized", "ff914c", "fine"];
                    } else if(pleasantness >= -0.33) {
                        return ["Restless", "e64f22", "confused"];
                    } else if(pleasantness >= -0.67) {
                        return ["Stressed", "d72121", "sad"];
                    } else {
                        return ["Fuming", "9b0b00", "wa"];
                    }
                } else if(energy >= 0) {
                    if(pleasantness >= 0.67) {
                        return ["Blissful", "ffde59", "o"];
                    } else if(pleasantness >= 0.33) {
                        return ["Cheerful", "febd59", "smile"];
                    } else if(pleasantness >= 0) {
                        return ["Pleasant", "ff914c", "fine"];
                    } else if(pleasantness >= -0.33) {
                        return ["Uneasy", "e64f22", "confused"];
                    } else if(pleasantness >= -0.67) {
                        return ["Worried", "d72121", "cry"];
                    } else {
                        return ["Anxious,", "9b0b00", "cry"];
                    }
                } else if(energy >= -0.33) {
                    if(pleasantness >= 0.67) {
                        return ["Fulfilled", "6b7a41", "cat"];
                    } else if(pleasantness >= 0.33) {
                        return ["Content", "a1ad7e", "cute"];
                    } else if(pleasantness >= 0) {
                        return ["At ease", "c3d098", "fine"];
                    } else if(pleasantness >= -0.33) {
                        return ["Apathetic", "d1dae6", "neutral"];
                    } else if(pleasantness >= -0.67) {
                        return ["Down", "89b1cb", "sad"];
                    } else {
                        return ["Anxious", "688ca9", "cry"];
                    }
                } else if(energy >= -0.67) {
                    if(pleasantness >= 0.67) {
                        return ["Satisfied", "6b7a41", "cat"];
                    } else if(pleasantness >= 0.33) {
                        return ["Restful", "a1ad7e", "satisfied"];
                    } else if(pleasantness >= 0) {
                        return ["Relaxed", "c3d098", "sus"];
                    } else if(pleasantness >= -0.33) {
                        return ["Tired", "d1dae6", "confused"];
                    } else if(pleasantness >= -0.67) {
                        return ["Sad", "89b1cb", "sad"];
                    } else {
                        return ["Miserable", "688ca9", "cry"];
                    }
                } else {
                    if(pleasantness >= 0.67) {
                        return ["Serene", "6b7a41", "cat"];
                    } else if(pleasantness >= 0.33) {
                        return ["Tranquil", "a1ad7e", "satisfied"];
                    } else if(pleasantness >= 0) {
                        return ["Sleepy", "c3d098", "sus"];
                    } else if(pleasantness >= -0.33) {
                        return ["Drained", "d1dae6", "sus"];
                    } else if(pleasantness >= -0.67) {
                        return ["Desolate", "89b1cb", "wa"];
                    } else {
                        return ["Despair", "688ca9", "cry"];
                    }
                }
                return ["Unknown", "ffffff", "neutral"];
            }

            moods.addEventListener("click", update);
            let dragging = false;
            dot.addEventListener("mousedown", e => {
                dragging = true;
            });
            dot.addEventListener("touchstart", e => {
                dragging = true;
            });
            moods.addEventListener("mousemove", e => {
                if(!dragging) return;
                update(e);
            });
            moods.addEventListener("touchmove", e => {
                if(!dragging) return;
                update(e.touches[0]);
            });
            window.addEventListener("mouseup", e => {
                dragging = false;
            });
            window.addEventListener("touchend", e => {
                dragging = false;
            });
            function isMobile() {
                var match = window.matchMedia || window.msMatchMedia;
                if (match) {
                    var mq = match("(pointer:coarse)");
                    return mq.matches;
                }
                return false;
                }
            var mobile = isMobile();
            dot.addEventListener("contextmenu", e => {
                e.preventDefault();
                console.log("pleasant: " + lastPleasantness + ", energy: " + lastEnergy);
                send();
            });
            if(mobile) moods.addEventListener("contextmenu", e => {
                e.preventDefault();
                console.log("pleasant: " + lastPleasantness + ", energy: " + lastEnergy);
                send();
            });
        </script>
        <script src="./echarts.min.js"></script>
        <script>
            if(localStorage.admin) {
                document.getElementById("add-mood").hidden = false;
                document.getElementById("add-mood-button").addEventListener("click", e => {
                    let date = new Date(document.getElementById("add-mood-date").value);
                    let pleasantness = +document.getElementById("add-mood-pleasantness").value;
                    let energy = +document.getElementById("add-mood-energy").value;
                    if(isNaN(pleasantness) || isNaN(energy)) return alert("Invalid values");
                    if(pleasantness < -1 || pleasantness > 1 || energy < -1 || energy > 1) return alert("Invalid values");
                    if(!localStorage.admin) return alert("No admin password");
                    fetch("/services/mood/setmultiple", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            moods: [{
                                pleasantness,
                                energy,
                                timestamp: date.getTime()
                            }],
                            pass: localStorage.admin
                        })
                    }).then(res => res.text()).then(res => {
                        alert(res);
                    });
                });
            }
            let lastMoods = [];
            const mood_epoch = 1682726400 * 1000;
            const dateInput = document.getElementById("after");
            const heatmapDots = document.getElementById("heatmap-dots");
            dateInput.value = new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString().split("T")[0];
            dateInput.addEventListener("change", e => {
                let dateDiff = Date.now() - new Date(e.target.value).getTime();
                if(smaElement.value == 1 && dateDiff > 1000 * 60 * 60 * 24 * 31 * 3) {
                    smaElement.value = 40;
                }
                updateData(new Date(e.target.value).getTime());
            });
            document.getElementById("all").addEventListener("click", e => {
                dateInput.value = new Date(mood_epoch).toISOString().split("T")[0];
                let dateDiff = Date.now() - new Date(dateInput.value).getTime();
                if(smaElement.value == 1 && dateDiff > 1000 * 60 * 60 * 24 * 31 * 3) {
                    smaElement.value = 40;
                }
                updateData(new Date(dateInput.value).getTime());
            });
            const smaElement = document.getElementById("sma");
            smaElement.addEventListener("change", e => {
                setMainChart(wmaElement.checked ? getWMA(lastMoods) : getSMA(lastMoods));
            });
            const wmaElement = document.getElementById("wma");
            wmaElement.addEventListener("change", e => {
                setMainChart(wmaElement.checked ? getWMA(lastMoods) : getSMA(lastMoods));
            });

            function getSMA(data) {
                const smaNumber = +smaElement.value;
                if(smaNumber <= 1) return data;
                const sma = [];

                for(let i = 0; i < data.length; i++) {
                    let sum = [0, 0];
                    let count = 0;
                    for(let j = i; j < i + smaNumber && j < data.length; j++) {
                        sum[0] += data[j][0];
                        sum[1] += data[j][1];
                        count++;
                    }
                    sma.push([+(sum[0] / count).toFixed(4), +(sum[1] / count).toFixed(4), data[i][2]]);
                }

                return sma;
            }

            function getWMA(data) {
                const wmaNumber = +smaElement.value;
                if(wmaNumber <= 1) return data;
                const wma = [];

                for(let i = 0; i < data.length; i++) {
                    let sum = [0, 0];
                    let weightSum = 0;
                    for(let j = i; j < i + wmaNumber && j < data.length; j++) {
                        let weight = j < data.length - 1 ? data[j + 1][2] - data[j][2] : 0; // Use the difference between timestamps as the weight
                        sum[0] += data[j][0] * weight;
                        sum[1] += data[j][1] * weight;
                        weightSum += weight;
                    }
                    // Use the timestamp from the middle point of the window
                    let middleIndex = i + Math.floor(wmaNumber / 2);
                    middleIndex = Math.min(middleIndex, data.length - 1); // Ensure middleIndex is within the bounds of the data array
                    wma.push([+(sum[0] / weightSum).toFixed(4), +(sum[1] / weightSum).toFixed(4), data[middleIndex][2]]);
                }

                return wma;
            }

            function setMainChart(data) {
                const mainchart = echarts.init(document.getElementById('mainchart'));

                mainchart.setOption({
                    xAxis: {
                        type: 'time',
                        data: data.map(i => i[2]),
                        axisPointer: {
                            label: {
                                formatter: function (params) {
                                    return new Date(params.value).toLocaleString()
                                }
                            }
                        },
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data: ['Pleaseantness', 'Energy']
                    },
                    yAxis: {
                        type: 'value',
                        min: -1,
                        max: 1
                    },
                    series: [
                        {
                            name: 'Pleaseantness',
                            data: data.map(i => [i[2], i[0]]),
                            type: 'line',
                            smooth: true,
                            showSymbol: data.length < 500,
                        },
                        {
                            name: 'Energy',
                            data: data.map(i => [i[2], i[1]]),
                            type: 'line',
                            smooth: true,
                            showSymbol: data.length < 500,
                        },
                    ],
                    animation: data.length < 500
                });
                mainchart.resize({
                    width: innerWidth * 0.9,
                    height: 400
                });
                mainchart.on('click', function (params) {
                    let date = new Date(params.data[0]);
                    document.getElementById("add-mood-date").value = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, "0")}-${date.getDate().toString().padStart(2, "0")}T${date.getHours().toString().padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`;
                });
            }

            function setHourlyEnergyChart(d) {
                const chart = echarts.init(document.getElementById('hourly-average-energy'));

                // Sort the data array by time in ascending order
                const data = d.sort((a, b) => a[2] - b[2]);
                let values = new Array(24).fill(0);
                let startDate = data[0][2].getTime();
                let endDate = data[data.length - 1][2].getTime();
                let c = 0;

                // Binary search function to find the closest mood
                function binarySearch(time) {
                    let start = 0;
                    let end = data.length - 1;
                    while (start <= end) {
                        let mid = Math.floor((start + end) / 2);
                        if (data[mid][2].getTime() === time) {
                            return data[mid];
                        } else if (data[mid][2].getTime() < time) {
                            start = mid + 1;
                        } else {
                            end = mid - 1;
                        }
                    }
                    // Return the closest mood
                    return Math.abs(data[start][2].getTime() - time) < Math.abs(data[end][2].getTime() - time) ? data[start] : data[end];
                }

                // Iterate through every 5 minutes finding the closest mood using binary search
                for(let d = startDate; d < endDate; d += 1000 * 60 * 5, c++) {
                    let closest = binarySearch(d);
                    values[new Date(d).getHours()] += closest[1];
                }

                for(let i = 0; i < values.length; i++) {
                    values[i] /= c;
                }
                let min = Math.min(...values);
                let max = Math.max(...values);
                let m = Math.max(Math.abs(min), Math.abs(max));

                chart.setOption({
                    polar: {
                        radius: [30, '80%']
                    },
                    radiusAxis: {
                        max: +(m * 1.1).toFixed(2),
                        min: +(-m * 1.1).toFixed(2),
                    },
                    angleAxis: {
                        type: 'category',
                        data: [
                            '00', '01', '02', '03', '04', '05', '06', '07', '08', '09',
                            '10', '11', '12', '13', '14', '15', '16', '17', '18', '19',
                            '20', '21', '22', '23'
                        ],
                    },
                    series: {
                        type: 'bar',
                        data: values,
                        coordinateSystem: 'polar'
                    },
                    animation: false
                });
                chart.resize({
                    width: innerWidth > 700 ? 700 : innerWidth * 0.9,
                    height: 600
                });
            }

            function setHourlyPleasantnessChart(d) {
                const chart = echarts.init(document.getElementById('hourly-average-pleasantness'));

                // Sort the data array by time in ascending order
                const data = d.sort((a, b) => a[2] - b[2]);
                let values = new Array(24).fill(0);
                let startDate = data[0][2].getTime();
                let endDate = data[data.length - 1][2].getTime();
                let c = 0;

                // Binary search function to find the closest mood
                function binarySearch(time) {
                    let start = 0;
                    let end = data.length - 1;
                    while (start <= end) {
                        let mid = Math.floor((start + end) / 2);
                        if (data[mid][2].getTime() === time) {
                            return data[mid];
                        } else if (data[mid][2].getTime() < time) {
                            start = mid + 1;
                        } else {
                            end = mid - 1;
                        }
                    }
                    // Return the closest mood
                    return Math.abs(data[start][2].getTime() - time) < Math.abs(data[end][2].getTime() - time) ? data[start] : data[end];
                }

                // Iterate through every 5 minutes finding the closest mood using binary search
                for(let d = startDate; d < endDate; d += 1000 * 60 * 5, c++) {
                    let closest = binarySearch(d);
                    values[new Date(d).getHours()] += closest[0];
                }

                for(let i = 0; i < values.length; i++) {
                    values[i] /= c;
                }
                let min = Math.min(...values);
                let max = Math.max(...values);
                let m = Math.max(Math.abs(min), Math.abs(max));

                chart.setOption({
                    polar: {
                        radius: [30, '80%']
                    },
                    radiusAxis: {
                        max: +(m * 1.1).toFixed(2),
                        min: +(-m * 1.1).toFixed(2),
                    },
                    angleAxis: {
                        type: 'category',
                        data: [
                            '00', '01', '02', '03', '04', '05', '06', '07', '08', '09',
                            '10', '11', '12', '13', '14', '15', '16', '17', '18', '19',
                            '20', '21', '22', '23'
                        ],
                    },
                    series: {
                        type: 'bar',
                        data: values,
                        coordinateSystem: 'polar'
                    },
                    animation: false
                });
                chart.resize({
                    width: innerWidth > 700 ? 700 : innerWidth * 0.9,
                    height: 600
                });
            }

            function setDailyPleasantnessChart(d) {
                let el = document.getElementById('daily-average-pleasantness');
                const chart = echarts.init(el);

                // Sort the data array by time in ascending order
                const data = d.sort((a, b) => a[2] - b[2]);
                let values = {};
                let startDate = Math.floor(data[0][2].getTime() / (1000 * 60 * 5)) * (1000 * 60 * 5);
                let endDate = data[data.length - 1][2].getTime();

                // Binary search function to find the closest mood
                function binarySearch(time) {
                    let start = 0;
                    let end = data.length - 1;
                    while (start <= end) {
                        let mid = Math.floor((start + end) / 2);
                        if (data[mid][2].getTime() === time) {
                            return data[mid];
                        } else if (data[mid][2].getTime() < time) {
                            start = mid + 1;
                        } else {
                            end = mid - 1;
                        }
                    }
                    // Ensure start and end are within the bounds of the data array
                    start = Math.max(0, Math.min(data.length - 1, start));
                    end = Math.max(0, Math.min(data.length - 1, end));
                    // Return the closest mood
                    return Math.abs(data[start][2].getTime() - time) < Math.abs(data[end][2].getTime() - time) ? data[start] : data[end];
                }

                // Iterate through every 5 minutes finding the closest mood using binary search
                for(let d = startDate; d < endDate; d += 1000 * 60 * 5) {
                    let closest = binarySearch(d);
                    if(closest[1] < -0.8) continue; // most likely asleep
                    let date = new Date(d).toISOString().split("T")[0];
                    if(!values[date]) values[date] = [];
                    values[date].push(closest[0]);
                }
                for(let i in values) {
                    values[i] = values[i].reduce((a, b) => a + b, 0) / values[i].length;
                    values[i] = +values[i].toFixed(5);
                }
                let min, max;
                for(let i in values) {
                    if(!min || values[i] < min) min = values[i];
                    if(!max || values[i] > max) max = values[i];
                }
                let m = Math.max(Math.abs(min), Math.abs(max));

                let daysBetween = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));

                chart.setOption({
                    series: {
                        type: 'heatmap',
                        data: Object.entries(values),
                        coordinateSystem: 'calendar'
                    },
                    visualMap: {
                        min: -m,
                        max: m,
                        type: 'continuous',
                        orient: 'horizontal',
                        left: 'center',
                        show: false,
                        inRange: {
                            color: ['red', '#ef5350', '#56a698', 'green'],
                            symbolSize: [-1, 1]
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function (params) {
                            return params.value[0] + ': ' + params.value[1];
                        }
                    },
                    calendar: {
                        top: 40,
                        left: 30,
                        right: 30,
                        cellSize: [16, 16],
                        range: [new Date(startDate).toISOString().split("T")[0], new Date(endDate).toISOString().split("T")[0]],
                        itemStyle: {
                            borderWidth: 0.5
                        },
                        yearLabel: { show: false }
                    },
                    animation: false
                });
                el.style.width = Math.ceil(daysBetween / 7) * 16 + 60 + "px";
                chart.resize({
                    width: Math.ceil(daysBetween / 7) * 16 + 60,
                    height: 175
                });
            }
            function setDailyEnergyChart(d) {
                let el = document.getElementById('daily-average-energy');
                const chart = echarts.init(el);

                // Sort the data array by time in ascending order
                const data = d.sort((a, b) => a[2] - b[2]);
                let values = {};
                let startDate = Math.floor(data[0][2].getTime() / (1000 * 60 * 5)) * (1000 * 60 * 5);
                let endDate = data[data.length - 1][2].getTime();

                // Binary search function to find the closest mood
                function binarySearch(time) {
                    let start = 0;
                    let end = data.length - 1;
                    while (start <= end) {
                        let mid = Math.floor((start + end) / 2);
                        if (data[mid][2].getTime() === time) {
                            return data[mid];
                        } else if (data[mid][2].getTime() < time) {
                            start = mid + 1;
                        } else {
                            end = mid - 1;
                        }
                    }
                    // Ensure start and end are within the bounds of the data array
                    start = Math.max(0, Math.min(data.length - 1, start));
                    end = Math.max(0, Math.min(data.length - 1, end));
                    // Return the closest mood
                    return Math.abs(data[start][2].getTime() - time) < Math.abs(data[end][2].getTime() - time) ? data[start] : data[end];
                }

                // Iterate through every 5 minutes finding the closest mood using binary search
                for(let d = startDate; d < endDate; d += 1000 * 60 * 5) {
                    let closest = binarySearch(d);
                    if(closest[1] < -0.8) continue; // most likely asleep
                    let date = new Date(d).toISOString().split("T")[0];
                    if(!values[date]) values[date] = [];
                    values[date].push(closest[1]);
                }
                for(let i in values) {
                    values[i] = values[i].reduce((a, b) => a + b, 0) / values[i].length;
                    values[i] = +values[i].toFixed(5);
                }
                let min, max;
                for(let i in values) {
                    if(!min || values[i] < min) min = values[i];
                    if(!max || values[i] > max) max = values[i];
                }
                let m = Math.max(Math.abs(min), Math.abs(max));

                let daysBetween = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));

                chart.setOption({
                    series: {
                        type: 'heatmap',
                        data: Object.entries(values),
                        coordinateSystem: 'calendar'
                    },
                    visualMap: {
                        min: -m,
                        max: m,
                        type: 'continuous',
                        orient: 'horizontal',
                        left: 'center',
                        show: false,
                        inRange: {
                            color: ['blue', 'yellow'],
                            symbolSize: [-1, 1]
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function (params) {
                            return params.value[0] + ': ' + params.value[1];
                        }
                    },
                    calendar: {
                        top: 40,
                        left: 30,
                        right: 30,
                        cellSize: [16, 16],
                        range: [new Date(startDate).toISOString().split("T")[0], new Date(endDate).toISOString().split("T")[0]],
                        itemStyle: {
                            borderWidth: 0.5
                        },
                        yearLabel: { show: false }
                    },
                    animation: false
                });
                el.style.width = Math.ceil(daysBetween / 7) * 16 + 60 + "px";
                chart.resize({
                    width: Math.ceil(daysBetween / 7) * 16 + 60,
                    height: 175
                });
            }

            function setHeatmap(data) {
                const canvas = document.getElementById("heatmap-canvas");
                const ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, 518, 518);
                ctx.globalAlpha = data.length > 3000 ? 0.15 : data.length > 1000 ? 0.22 : data.length > 500 ? 0.3 : 0.5;
                let img = document.createElement("img");
                img.src = "./reddot.png";
                img.onload = () => {
                    for(let mood of data) {
                        let x = (mood[0] + 1) * 262;
                        let y = (mood[1] + 1) * 262;
                        y = 518 - y;

                        ctx.drawImage(img, x-6, y-6, 12, 12);
                    }
                }
            }

            function updateData(after) {
                fetch("/services/mood/file.mood?after="+after).then(i => i.arrayBuffer()).then(data => {
                    let dv = new DataView(data);
                    let moods = [];
                    for(let i = 0; i < data.byteLength; i += 6) {
                        moods.unshift([dv.getInt8(i) / 100, dv.getInt8(i + 1) / 100, new Date(mood_epoch + dv.getUint32(i + 2)*1000)]);
                    }
                    lastMoods = moods;

                    // setMainChart(getWMA(moods));
                    setMainChart(document.getElementById('wma').checked ? getWMA(moods) : getSMA(moods));
                    setHeatmap(moods);
                    setHourlyEnergyChart(moods);
                    setHourlyPleasantnessChart(moods);
                    setDailyPleasantnessChart(moods);
                    setDailyEnergyChart(moods);
                });
            }
            updateData(new Date(dateInput.value).getTime());
        </script>
    </body>
</html>